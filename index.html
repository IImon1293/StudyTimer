<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†ä¸­åŠ›ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é¤Šæˆã‚¿ã‚¤ãƒãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-hover: #2980b9;
            --danger: #e74c3c;
            --danger-hover: #c0392b;
            --success: #2ecc71;
            --success-hover: #27ae60;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #2c3e50;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            gap: 20px;
            display: flex;
            flex-direction: column;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        h1 {
            font-size: 1.5rem;
            margin-top: 0;
            color: var(--text);
        }

        /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
        .timer-display {
            font-size: 5rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
            transition: color 0.3s;
        }

        .timer-display.overrun {
            color: var(--danger);
        }

        /* è¤’ã‚è¨€è‘‰ */
        .praise-message {
            font-size: 1.2rem;
            font-weight: bold;
            color: #f39c12;
            min-height: 1.5em;
            margin-bottom: 15px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(10px);
        }

        .praise-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ãƒœã‚¿ãƒ³ç¾¤ */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            color: white;
            background-color: var(--primary);
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:active {
            transform: scale(0.95);
        }

        button.stop-btn {
            background-color: var(--danger);
            font-size: 1.2rem;
            padding: 15px 30px;
        }

        button.stop-btn:hover {
            background-color: var(--danger-hover);
        }

        button.break-btn {
            background-color: var(--success);
        }

        button.break-btn:hover {
            background-color: var(--success-hover);
        }

        /* ã‚«ã‚¹ã‚¿ãƒ è¨­å®š */
        .custom-setting {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }

        .custom-setting input {
            width: 60px;
            padding: 5px;
            font-size: 1rem;
            text-align: right;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .hidden {
            display: none !important;
        }

        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="card" id="timer-section">
            <h1>é›†ä¸­åŠ›ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é¤Šæˆã‚¿ã‚¤ãƒãƒ¼ ğŸ‘¾</h1>

            <div id="praise-box" class="praise-message"></div>

            <div id="timer-display" class="timer-display">00:00</div>

            <div id="study-controls">
                <p style="margin-bottom: 10px; font-size: 0.9rem; color: #7f8c8d;">ç›®æ¨™æ™‚é–“ã‚’é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
                <div class="btn-group" id="preset-buttons">
                </div>

                <div class="custom-setting">
                    <input type="number" id="custom-time" min="1" placeholder="åˆ†">
                    <button onclick="addCustomPreset()">è¿½åŠ </button>
                </div>
            </div>

            <div id="active-controls" class="hidden">
                <button class="stop-btn" onclick="stopTimer()">å…¨é›†ä¸­çµ‚äº†ï¼</button>
            </div>

            <div id="break-controls" class="hidden">
                <p style="margin-bottom: 10px; font-size: 0.9rem; color: #27ae60;">ãŠç–²ã‚Œæ§˜ï¼ä¼‘æ†©ã—ã‚ˆã†ğŸµ</p>
                <div class="btn-group">
                    <button class="break-btn" onclick="startTimer(5 * 60, false)">5åˆ† ä¼‘æ†©</button>
                    <button class="break-btn" onclick="startTimer(10 * 60, false)">10åˆ† ä¼‘æ†©</button>
                    <button class="break-btn" onclick="startTimer(30 * 60, false)">30åˆ† ä¼‘æ†©</button>
                    <button onclick="resetToStudy()">ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã¸</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h1>ä»Šé€±ã®é ‘å¼µã‚Šãƒ­ã‚° ğŸ“Š</h1>
            <div class="chart-container">
                <canvas id="logChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        /* --- çŠ¶æ…‹ç®¡ç† --- */
        let timerId = null;
        let targetSeconds = 0;
        let elapsedSeconds = 0;
        let isStudyMode = true;
        let audioContext = null;

        // è¤’ã‚è¨€è‘‰ãƒªã‚¹ãƒˆ
        const praiseMessages = [
            "ã‚ã€é›†ä¸­åŠ›ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç™ºè¦‹ï¼ğŸ‘¾",
            "è„³ã¿ããŒãƒ•ãƒ«ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã™ãã¦ç…™å‡ºã¦ãªã„ï¼ŸğŸ’¨",
            "å›ã®é›†ä¸­åŠ›ã€Wi-Fiã‚ˆã‚Šå®‰å®šã—ã¦ã‚‹ã­ã€‚ğŸ“¶",
            "ã‚¾ãƒ¼ãƒ³ã«å…¥ã£ã¦ãŸã­ï¼ã•ã™ãŒï¼âœ¨",
            "ãã®é›†ä¸­åŠ›ã€å›½å®ã«æŒ‡å®šã—ãŸã„ãƒ¬ãƒ™ãƒ«ï¼ğŸ†"
        ];

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼†ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒªã‚»ãƒƒãƒˆ
        let presets = JSON.parse(localStorage.getItem('focusMonster_presets')) || [10, 30, 60];

        /* --- åˆæœŸåŒ–å‡¦ç† --- */
        function init() {
            renderPresets();
            updateChart();
        }

        function renderPresets() {
            const container = document.getElementById('preset-buttons');
            container.innerHTML = '';
            presets.forEach(mins => {
                const btn = document.createElement('button');
                btn.textContent = `${mins}åˆ†`;
                btn.onclick = () => startTimer(mins * 60, true);
                container.appendChild(btn);
            });
        }

        function addCustomPreset() {
            const input = document.getElementById('custom-time');
            const val = parseInt(input.value);
            if (val > 0 && !presets.includes(val)) {
                presets.push(val);
                presets.sort((a, b) => a - b);
                localStorage.setItem('focusMonster_presets', JSON.stringify(presets));
                renderPresets();
            }
            input.value = '';
        }

        /* --- ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ --- */
        function startTimer(seconds, isStudy) {
            // AudioContextã®åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³èµ·ç‚¹å¿…é ˆã®ãŸã‚ã“ã“ã§è¡Œã†ï¼‰
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

            targetSeconds = seconds;
            elapsedSeconds = 0;
            isStudyMode = isStudy;

            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('study-controls').classList.add('hidden');
            document.getElementById('break-controls').classList.add('hidden');
            document.getElementById('active-controls').classList.remove('hidden');
            document.getElementById('praise-box').classList.remove('show');
            document.getElementById('timer-display').classList.remove('overrun');

            updateDisplay();

            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                elapsedSeconds++;
                updateDisplay();

                // ã‚¢ãƒ©ãƒ¼ãƒ ç™ºç«ã‚¿ã‚¤ãƒŸãƒ³ã‚°
                if (elapsedSeconds === targetSeconds) {
                    playAlarm();
                    if (!isStudyMode) {
                        // ä¼‘æ†©ãƒ¢ãƒ¼ãƒ‰ã¯0ã§è‡ªå‹•çµ‚äº†
                        stopTimer();
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerId);
            timerId = null;

            document.getElementById('active-controls').classList.add('hidden');
            document.getElementById('timer-display').classList.remove('overrun');

            if (isStudyMode && elapsedSeconds > 0) {
                // å‹‰å¼·ãƒ­ã‚°ã®è¨˜éŒ²ï¼ˆåˆ†å˜ä½ã«å¤‰æ›ã—ã¦åŠ ç®—ï¼‰
                saveLog(elapsedSeconds);
                updateChart();

                // è¤’ã‚ã¡ãã‚Šç™ºå‹•
                const praiseBox = document.getElementById('praise-box');
                const randomMsg = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
                praiseBox.textContent = randomMsg;
                praiseBox.classList.add('show');

                // ä¼‘æ†©ãƒ¢ãƒ¼ãƒ‰ã®UIã¸ç§»è¡Œ
                document.getElementById('break-controls').classList.remove('hidden');
            } else {
                // ä¼‘æ†©çµ‚äº†æ™‚ã€ã¾ãŸã¯0ç§’ã‚¹ãƒˆãƒƒãƒ—æ™‚
                resetToStudy();
            }

            // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’00:00ã«æˆ»ã™
            document.getElementById('timer-display').textContent = "00:00";
        }

        function resetToStudy() {
            if (timerId) clearInterval(timerId);
            document.getElementById('break-controls').classList.add('hidden');
            document.getElementById('study-controls').classList.remove('hidden');
            document.getElementById('praise-box').classList.remove('show');
            document.getElementById('timer-display').textContent = "00:00";
        }

        function updateDisplay() {
            const display = document.getElementById('timer-display');

            if (elapsedSeconds <= targetSeconds) {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­
                const remain = targetSeconds - elapsedSeconds;
                display.textContent = formatTime(remain);
            } else {
                // ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒ³ä¸­ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ï¼‰
                const over = elapsedSeconds - targetSeconds;
                display.textContent = "+" + formatTime(over);
                if (!display.classList.contains('overrun')) {
                    display.classList.add('overrun');
                }
            }
        }

        function formatTime(totalSec) {
            const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
            const s = (totalSec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        /* --- ã‚¢ãƒ©ãƒ¼ãƒ éŸ³å£° (Web Audio API) --- */
        // æŒ‡å®šã—ãŸãƒŸãƒªç§’ï¼ˆmsï¼‰ã ã‘å¾…æ©Ÿã™ã‚‹ã€Œsleepã€é–¢æ•°ã‚’å®šç¾©
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function playAlarm() {
            if (!audioContext) return;
            for (let i = 0; i < 10; i++) {
                // ãƒ”ãƒ”ãƒ”ãƒƒã¨3å›é³´ã‚‰ã™
                for (let j = 0; j < 3; j++) {
                    setTimeout(() => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(880, audioContext.currentTime); // ãƒ©ã®éŸ³

                        gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                        osc.connect(gain);
                        gain.connect(audioContext.destination);

                        osc.start();
                        osc.stop(audioContext.currentTime + 0.1);
                    }, i * 150);
                    if (i % 2 == 0) {
                        await sleep(50);
                    } else {
                        await sleep(500);
                    }
                }

            }
        }

        /* --- ãƒ­ã‚°ä¿å­˜ã¨ã‚°ãƒ©ãƒ•æç”» (Chart.js) --- */
        let logChartInstance = null;

        function saveLog(seconds) {
            const today = new Date().toLocaleDateString('ja-JP'); // YYYY/MM/DD
            const logs = JSON.parse(localStorage.getItem('focusMonster_logs')) || {};

            // åˆ†å˜ä½ã§åŠ ç®—ï¼ˆå°æ•°ç‚¹ç¬¬1ä½ã¾ã§ï¼‰
            const minutes = Math.round((seconds / 60) * 10) / 10;
            logs[today] = (logs[today] || 0) + minutes;

            localStorage.setItem('focusMonster_logs', JSON.stringify(logs));
        }

        function updateChart() {
            const logs = JSON.parse(localStorage.getItem('focusMonster_logs')) || {};
            const labels = [];
            const data = [];

            // ç›´è¿‘7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('ja-JP');

                // ã‚°ãƒ©ãƒ•ã®ãƒ©ãƒ™ãƒ«ã¯ã€ŒMM/DDã€ã«ã™ã‚‹
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
                data.push(logs[dateStr] || 0);
            }

            const ctx = document.getElementById('logChart').getContext('2d');

            if (logChartInstance) {
                logChartInstance.data.labels = labels;
                logChartInstance.data.datasets[0].data = data;
                logChartInstance.update();
            } else {
                logChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å‹‰å¼·æ™‚é–“ (åˆ†)',
                            data: data,
                            backgroundColor: '#3498db',
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return ` ${context.raw} åˆ† é ‘å¼µã£ãŸï¼`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ã‚¢ãƒ—ãƒªèµ·å‹•
        init();

    </script>
</body>

</html>